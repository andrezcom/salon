const axios = require('axios');

const BASE_URL = 'http://localhost:3000/api';
const TEST_USER_ID = '68b871502ef2b330e41d2391'; // Usuario de prueba existente
const BUSINESS_ID = '68b8c3e2c9765a8720a6b622'; // Negocio de prueba existente

async function testPurchaseOrderSystem() {
  console.log('üìã Iniciando pruebas del sistema de √≥rdenes de compra...\n');

  try {
    // ===== ESCENARIO 1: CREAR PRODUCTOS CON STOCK BAJO =====
    console.log('üì¶ ESCENARIO 1: Crear productos con stock bajo\n');

    // Crear producto con stock bajo
    console.log('üíÑ Creando producto con stock bajo...');
    const product1Response = await axios.post(`${BASE_URL}/inventory/business/${BUSINESS_ID}/products`, {
      name: 'Tinte Wella Color Touch',
      brand: 'Wella',
      category: 'Coloraci√≥n',
      subcategory: 'Tinte',
      costPrice: 45.00,
      inputPrice: 0.90, // Precio por ml (50ml = $45)
      clientPrice: 65.00,
      expertPrice: 55.00,
      packageInfo: {
        qtyPerPackage: 1,
        unitSize: 50, // 50ml por tubo
        unitType: 'ml',
        packageType: 'tubo'
      },
      uses: {
        isInput: true,
        isRetail: true,
        isWholesale: false
      },
      inventory: {
        currentStock: 2, // Stock bajo
        minimumStock: 5,
        maximumStock: 30,
        reorderPoint: 5,
        reorderQuantity: 15
      },
      supplier: {
        name: 'Distribuidora Wella Pro',
        contact: 'Roberto Mart√≠nez',
        phone: '+52 55 1111 2222',
        email: 'ventas@wella.com'
      },
      description: 'Tinte profesional para retoques de color',
      tags: ['tinte', 'color', 'profesional'],
      userId: TEST_USER_ID
    });

    if (!product1Response.data.success) {
      throw new Error('No se pudo crear el producto 1');
    }

    const product1Id = product1Response.data.data._id;
    console.log(`‚úÖ Producto creado: ${product1Id}`);
    console.log(`   ‚Ä¢ Stock actual: ${product1Response.data.data.inventory.currentStock}`);
    console.log(`   ‚Ä¢ Stock m√≠nimo: ${product1Response.data.data.inventory.minimumStock}`);
    console.log(`   ‚Ä¢ Necesita reorden: ${product1Response.data.data.inventory.currentStock <= product1Response.data.data.inventory.minimumStock ? 'S√ç' : 'NO'}`);

    // Crear producto sin stock
    console.log('\nüíÑ Creando producto sin stock...');
    const product2Response = await axios.post(`${BASE_URL}/inventory/business/${BUSINESS_ID}/products`, {
      name: 'Mascarilla Kerastase Elixir',
      brand: 'Kerastase',
      category: 'Tratamiento',
      subcategory: 'Mascarilla',
      costPrice: 85.00,
      inputPrice: 1.70, // Precio por ml (50ml = $85)
      clientPrice: 120.00,
      expertPrice: 100.00,
      packageInfo: {
        qtyPerPackage: 1,
        unitSize: 50, // 50ml por tubo
        unitType: 'ml',
        packageType: 'tubo'
      },
      uses: {
        isInput: true,
        isRetail: true,
        isWholesale: false
      },
      inventory: {
        currentStock: 0, // Sin stock
        minimumStock: 3,
        maximumStock: 20,
        reorderPoint: 3,
        reorderQuantity: 10
      },
      supplier: {
        name: 'Distribuidora L\'Or√©al Pro',
        contact: 'Ana Garc√≠a',
        phone: '+52 55 3333 4444',
        email: 'ventas@loreal.com'
      },
      description: 'Mascarilla reparadora para cabello da√±ado',
      tags: ['mascarilla', 'tratamiento', 'reparador'],
      userId: TEST_USER_ID
    });

    if (!product2Response.data.success) {
      throw new Error('No se pudo crear el producto 2');
    }

    const product2Id = product2Response.data.data._id;
    console.log(`‚úÖ Producto creado: ${product2Id}`);
    console.log(`   ‚Ä¢ Stock actual: ${product2Response.data.data.inventory.currentStock}`);
    console.log(`   ‚Ä¢ Stock m√≠nimo: ${product2Response.data.data.inventory.minimumStock}`);
    console.log(`   ‚Ä¢ Necesita reorden: ${product2Response.data.data.inventory.currentStock <= product2Response.data.data.inventory.minimumStock ? 'S√ç' : 'NO'}`);

    // ===== ESCENARIO 2: GENERAR INFORME DE STOCK M√çNIMO =====
    console.log('\nüìä ESCENARIO 2: Generar informe de stock m√≠nimo\n');

    // Obtener informe de stock m√≠nimo
    console.log('üìà Generando informe de stock m√≠nimo...');
    const lowStockReportResponse = await axios.get(`${BASE_URL}/purchase-order/business/${BUSINESS_ID}/inventory/low-stock-report`);
    
    if (lowStockReportResponse.data.success) {
      const report = lowStockReportResponse.data.data.report;
      console.log('‚úÖ Informe generado exitosamente:');
      console.log(`   ‚Ä¢ Total productos con stock bajo: ${report.totals.totalProducts}`);
      console.log(`   ‚Ä¢ Productos cr√≠ticos (sin stock): ${report.totals.criticalProducts}`);
      console.log(`   ‚Ä¢ Productos con advertencia: ${report.totals.warningProducts}`);
      console.log(`   ‚Ä¢ Total a invertir: $${report.totals.totalCost}`);
      console.log(`   ‚Ä¢ Total proveedores: ${report.totals.suppliers}`);
      
      console.log('\nüìã Productos que necesitan reorden:');
      report.items.forEach((item, index) => {
        console.log(`   ${index + 1}. ${item.productName} (${item.brand})`);
        console.log(`      ‚Ä¢ Stock actual: ${item.currentStock}`);
        console.log(`      ‚Ä¢ Stock m√≠nimo: ${item.minimumStock}`);
        console.log(`      ‚Ä¢ Cantidad sugerida: ${item.suggestedQuantity}`);
        console.log(`      ‚Ä¢ Costo total: $${item.totalCost}`);
        console.log(`      ‚Ä¢ Urgencia: ${item.urgencyLevel.toUpperCase()}`);
        console.log(`      ‚Ä¢ Raz√≥n: ${item.reason}`);
      });
      
      console.log('\nüè¢ Agrupaci√≥n por proveedor:');
      Object.entries(report.supplierGroups).forEach(([supplierName, group], index) => {
        console.log(`   ${index + 1}. ${supplierName}`);
        console.log(`      ‚Ä¢ Productos: ${group.items.length}`);
        console.log(`      ‚Ä¢ Total a invertir: $${group.totalCost}`);
        console.log(`      ‚Ä¢ Total unidades: ${group.totalItems}`);
      });
    }

    // ===== ESCENARIO 3: GENERAR √ìRDENES AUTOM√ÅTICAS =====
    console.log('\nü§ñ ESCENARIO 3: Generar √≥rdenes autom√°ticas\n');

    // Generar √≥rdenes autom√°ticas
    console.log('üîÑ Generando √≥rdenes autom√°ticas...');
    const autoOrderResponse = await axios.post(`${BASE_URL}/purchase-order/business/${BUSINESS_ID}/purchase-orders/generate-automatic`, {
      includeLowStock: true,
      includeOutOfStock: true,
      userId: TEST_USER_ID
    });

    if (autoOrderResponse.data.success) {
      const orders = autoOrderResponse.data.data.orders;
      console.log(`‚úÖ √ìrdenes generadas: ${orders.length}`);
      
      orders.forEach((order, index) => {
        console.log(`\n   üìã Orden ${index + 1}: ${order.orderNumber}`);
        console.log(`      ‚Ä¢ Proveedor: ${order.supplier.name}`);
        console.log(`      ‚Ä¢ Estado: ${order.status}`);
        console.log(`      ‚Ä¢ Tipo: ${order.orderType}`);
        console.log(`      ‚Ä¢ Total: $${order.totalAmount}`);
        console.log(`      ‚Ä¢ Productos: ${order.items.length}`);
        
        order.items.forEach((item, itemIndex) => {
          console.log(`         ${itemIndex + 1}. ${item.productName}`);
          console.log(`            ‚Ä¢ Cantidad: ${item.quantity}`);
          console.log(`            ‚Ä¢ Costo unitario: $${item.unitCost}`);
          console.log(`            ‚Ä¢ Total: $${item.totalCost}`);
          console.log(`            ‚Ä¢ Raz√≥n: ${item.reason}`);
        });
      });
    }

    // ===== ESCENARIO 4: CREAR ORDEN MANUAL =====
    console.log('\n‚úçÔ∏è ESCENARIO 4: Crear orden manual\n');

    // Crear orden manual
    console.log('üìù Creando orden manual...');
    const manualOrderResponse = await axios.post(`${BASE_URL}/purchase-order/business/${BUSINESS_ID}/purchase-orders`, {
      supplier: {
        name: 'Distribuidora de Belleza Premium',
        contact: 'Carlos L√≥pez',
        phone: '+52 55 5555 6666',
        email: 'ventas@premium.com'
      },
      items: [
        {
          productId: product1Id,
          quantity: 20,
          unitCost: 45.00
        },
        {
          productId: product2Id,
          quantity: 15,
          unitCost: 85.00
        }
      ],
      notes: 'Orden manual para stock de temporada alta',
      expectedDeliveryDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 d√≠as
      userId: TEST_USER_ID
    });

    if (manualOrderResponse.data.success) {
      const order = manualOrderResponse.data.data;
      console.log('‚úÖ Orden manual creada exitosamente:');
      console.log(`   ‚Ä¢ N√∫mero: ${order.orderNumber}`);
      console.log(`   ‚Ä¢ Proveedor: ${order.supplier.name}`);
      console.log(`   ‚Ä¢ Estado: ${order.status}`);
      console.log(`   ‚Ä¢ Total: $${order.totalAmount}`);
      console.log(`   ‚Ä¢ Productos: ${order.items.length}`);
    }

    // ===== ESCENARIO 5: APROBAR Y ENVIAR ORDEN =====
    console.log('\n‚úÖ ESCENARIO 5: Aprobar y enviar orden\n');

    // Obtener la primera orden autom√°tica
    const ordersResponse = await axios.get(`${BASE_URL}/purchase-order/business/${BUSINESS_ID}/purchase-orders`);
    const firstOrder = ordersResponse.data.data[0];

    if (firstOrder) {
      // Aprobar orden
      console.log(`‚úÖ Aprobando orden: ${firstOrder.orderNumber}...`);
      const approveResponse = await axios.put(`${BASE_URL}/purchase-order/business/${BUSINESS_ID}/purchase-orders/${firstOrder._id}/approve`, {
        notes: 'Orden aprobada por gerente de compras',
        userId: TEST_USER_ID
      });

      if (approveResponse.data.success) {
        console.log('‚úÖ Orden aprobada exitosamente');
        console.log(`   ‚Ä¢ Estado: ${approveResponse.data.data.status}`);
        console.log(`   ‚Ä¢ Aprobada por: ${approveResponse.data.data.approvedBy}`);
      }

      // Enviar orden
      console.log(`üì§ Enviando orden: ${firstOrder.orderNumber}...`);
      const sendResponse = await axios.put(`${BASE_URL}/purchase-order/business/${BUSINESS_ID}/purchase-orders/${firstOrder._id}/send`, {
        notes: 'Orden enviada al proveedor por email',
        userId: TEST_USER_ID
      });

      if (sendResponse.data.success) {
        console.log('‚úÖ Orden enviada exitosamente');
        console.log(`   ‚Ä¢ Estado: ${sendResponse.data.data.status}`);
        console.log(`   ‚Ä¢ Enviada por: ${sendResponse.data.data.sentBy}`);
      }
    }

    // ===== ESCENARIO 6: MARCAR COMO RECIBIDA =====
    console.log('\nüì¶ ESCENARIO 6: Marcar orden como recibida\n');

    if (firstOrder) {
      // Marcar como recibida
      console.log(`üì¶ Marcando orden como recibida: ${firstOrder.orderNumber}...`);
      const receiveResponse = await axios.put(`${BASE_URL}/purchase-order/business/${BUSINESS_ID}/purchase-orders/${firstOrder._id}/receive`, {
        notes: 'Orden recibida y verificada',
        userId: TEST_USER_ID
      });

      if (receiveResponse.data.success) {
        console.log('‚úÖ Orden marcada como recibida exitosamente');
        console.log(`   ‚Ä¢ Estado: ${receiveResponse.data.data.status}`);
        console.log(`   ‚Ä¢ Recibida por: ${receiveResponse.data.data.receivedBy}`);
        console.log(`   ‚Ä¢ Fecha de recepci√≥n: ${receiveResponse.data.data.actualDeliveryDate}`);
        console.log('   ‚Ä¢ Stock actualizado autom√°ticamente');
      }
    }

    // ===== VERIFICAR √ìRDENES =====
    console.log('\nüìã VERIFICANDO √ìRDENES\n');

    // Obtener todas las √≥rdenes
    console.log('üìä Obteniendo todas las √≥rdenes...');
    const allOrdersResponse = await axios.get(`${BASE_URL}/purchase-order/business/${BUSINESS_ID}/purchase-orders`);
    
    if (allOrdersResponse.data.success) {
      const orders = allOrdersResponse.data.data;
      console.log(`‚úÖ √ìrdenes obtenidas: ${orders.length}`);
      
      orders.forEach((order, index) => {
        console.log(`   ${index + 1}. ${order.orderNumber}`);
        console.log(`      ‚Ä¢ Proveedor: ${order.supplier.name}`);
        console.log(`      ‚Ä¢ Estado: ${order.status}`);
        console.log(`      ‚Ä¢ Tipo: ${order.orderType}`);
        console.log(`      ‚Ä¢ Total: $${order.totalAmount}`);
        console.log(`      ‚Ä¢ Fecha: ${order.orderDate}`);
      });
    }

    // ===== VERIFICAR RESUMEN DE √ìRDENES =====
    console.log('\nüìà VERIFICANDO RESUMEN DE √ìRDENES\n');

    // Obtener resumen de √≥rdenes
    console.log('üìä Obteniendo resumen de √≥rdenes...');
    const summaryResponse = await axios.get(`${BASE_URL}/purchase-order/business/${BUSINESS_ID}/purchase-orders/summary`);
    
    if (summaryResponse.data.success) {
      const summary = summaryResponse.data.data;
      console.log('‚úÖ Resumen obtenido:');
      console.log(`   ‚Ä¢ Total √≥rdenes: ${summary.totals.totalOrders}`);
      console.log(`   ‚Ä¢ Monto total: $${summary.totals.totalAmount}`);
      console.log(`   ‚Ä¢ Total items: ${summary.totals.totalItems}`);
      console.log(`   ‚Ä¢ Borradores: ${summary.totals.draftOrders}`);
      console.log(`   ‚Ä¢ Pendientes: ${summary.totals.pendingOrders}`);
      console.log(`   ‚Ä¢ Aprobadas: ${summary.totals.approvedOrders}`);
      console.log(`   ‚Ä¢ Enviadas: ${summary.totals.sentOrders}`);
      console.log(`   ‚Ä¢ Recibidas: ${summary.totals.receivedOrders}`);
    }

    // ===== VERIFICAR STOCK ACTUALIZADO =====
    console.log('\nüì¶ VERIFICANDO STOCK ACTUALIZADO\n');

    // Verificar stock de productos
    console.log('üìä Verificando stock actualizado...');
    const productsResponse = await axios.get(`${BASE_URL}/inventory/business/${BUSINESS_ID}/products`);
    
    if (productsResponse.data.success) {
      const products = productsResponse.data.data;
      console.log(`‚úÖ Productos verificados: ${products.length}`);
      
      products.forEach((product, index) => {
        console.log(`   ${index + 1}. ${product.name} (${product.brand})`);
        console.log(`      ‚Ä¢ Stock actual: ${product.inventory.currentStock}`);
        console.log(`      ‚Ä¢ Stock m√≠nimo: ${product.inventory.minimumStock}`);
        console.log(`      ‚Ä¢ Necesita reorden: ${product.inventory.currentStock <= product.inventory.minimumStock ? 'S√ç' : 'NO'}`);
      });
    }

    // ===== RESUMEN FINAL =====
    console.log('\nüéâ ¬°SISTEMA DE √ìRDENES DE COMPRA PROBADO EXITOSAMENTE!');
    console.log('\nüìã RESUMEN DE LA PRUEBA:');
    console.log(`   ‚Ä¢ Productos creados: 2`);
    console.log(`   ‚Ä¢ Producto con stock bajo: Tinte Wella (2 unidades)`);
    console.log(`   ‚Ä¢ Producto sin stock: Mascarilla Kerastase (0 unidades)`);
    console.log(`   ‚Ä¢ √ìrdenes generadas: ${autoOrderResponse.data.data.orders.length + 1}`);
    console.log(`   ‚Ä¢ √ìrdenes autom√°ticas: ${autoOrderResponse.data.data.orders.length}`);
    console.log(`   ‚Ä¢ √ìrdenes manuales: 1`);
    console.log(`   ‚Ä¢ Stock actualizado autom√°ticamente`);

    console.log('\nüí° FUNCIONALIDADES IMPLEMENTADAS:');
    console.log(`   ‚úÖ Informe de stock m√≠nimo detallado`);
    console.log(`   ‚úÖ Generaci√≥n autom√°tica de √≥rdenes`);
    console.log(`   ‚úÖ Creaci√≥n de √≥rdenes manuales`);
    console.log(`   ‚úÖ Aprobaci√≥n de √≥rdenes`);
    console.log(`   ‚úÖ Env√≠o de √≥rdenes a proveedores`);
    console.log(`   ‚úÖ Recepci√≥n y actualizaci√≥n de stock`);
    console.log(`   ‚úÖ Agrupaci√≥n por proveedor`);
    console.log(`   ‚úÖ C√°lculo autom√°tico de cantidades`);
    console.log(`   ‚úÖ Niveles de urgencia (cr√≠tico, advertencia)`);
    console.log(`   ‚úÖ Reportes y res√∫menes completos`);
    console.log(`   ‚úÖ Integraci√≥n con sistema de inventario`);

    console.log('\nüöÄ EL SISTEMA DE √ìRDENES DE COMPRA EST√Å LISTO PARA PRODUCCI√ìN!');

  } catch (error) {
    console.error('‚ùå Error en la prueba:', error.message);
    if (error.response) {
      console.error('üìä Respuesta del servidor:', error.response.status, error.response.data);
    }
  }
}

// Ejecutar las pruebas
testPurchaseOrderSystem();
