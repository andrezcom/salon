const axios = require('axios');

const BASE_URL = 'http://localhost:3000/api';
const TEST_USER_ID = '68b871502ef2b330e41d2391'; // Usuario de prueba existente
const BUSINESS_ID = '68b8c3e2c9765a8720a6b622'; // Negocio de prueba existente

async function testTipsAndChangeSystem() {
  console.log('üí∞ Iniciando pruebas del sistema de propinas y devoluciones...\n');

  try {
    // ===== ESCENARIO 1: CLIENTE PAGA CON TARJETA, PROPINA EN EFECTIVO =====
    console.log('üí≥ ESCENARIO 1: Cliente paga con tarjeta, propina en efectivo\n');

    // Crear un cliente
    console.log('üë§ Creando cliente para escenario 1...');
    const client1Response = await axios.post(`${BASE_URL}/business/${BUSINESS_ID}/client`, {
      nameClient: 'Cliente Tarjeta',
      email: 'tarjeta@cliente.com',
      phone1: '555-6666'
    });

    if (!client1Response.data.success) {
      throw new Error('No se pudo crear el cliente 1');
    }

    const client1Id = client1Response.data.data._id;
    console.log(`‚úÖ Cliente creado: ${client1Id}`);

    // Crear un experto
    console.log('\nüë®‚Äçüíº Creando experto para escenario 1...');
    const expert1Response = await axios.post(`${BASE_URL}/business/${BUSINESS_ID}/expert`, {
      nameExpert: 'Experto Tarjeta',
      aliasExpert: 'Tarjeta',
      email: 'tarjeta@experto.com',
      phone: '555-7777',
      role: {
        stylist: true,
        manicure: false,
        makeup: false
      },
      commissionSettings: {
        serviceCommission: 20,
        retailCommission: 10,
        serviceCalculationMethod: 'after_inputs',
        minimumServiceCommission: 5,
        maximumServiceCommission: 100
      }
    });

    if (!expert1Response.data.success) {
      throw new Error('No se pudo crear el experto 1');
    }

    const expert1Id = expert1Response.data.data._id;
    console.log(`‚úÖ Experto creado: ${expert1Id}`);

    // Crear una venta pagada con tarjeta
    console.log('\nüõí Creando venta pagada con tarjeta...');
    const sale1Response = await axios.post(`${BASE_URL}/business/${BUSINESS_ID}/sale`, {
      idClient: client1Id,
      nameClient: 'Cliente Tarjeta',
      email: 'tarjeta@cliente.com',
      date: new Date().toISOString(),
      services: [{
        serviceId: 1,
        expertId: expert1Id,
        input: [{
          inputId: 1,
          nameProduct: 'Shampoo Profesional',
          inputPrice: 15.00,
          qty: 1,
          amount: 15.00
        }],
        amount: 80.00
      }],
      retail: [],
      total: 80.00,
      paymentMethod: [{
        payment: 'Tarjeta',
        amount: 80.00
      }],
      totalReceived: 80.00,
      totalChange: 0
    });

    if (!sale1Response.data.success) {
      throw new Error('No se pudo crear la venta 1');
    }

    const sale1Id = sale1Response.data.data._id;
    console.log(`‚úÖ Venta creada: ${sale1Id}`);
    console.log(`   ‚Ä¢ Servicio: $80.00`);
    console.log(`   ‚Ä¢ Insumos: $15.00`);
    console.log(`   ‚Ä¢ Total: $80.00`);
    console.log(`   ‚Ä¢ M√©todo de pago: Tarjeta`);

    // Cerrar la venta
    console.log('\nüìÑ Cerrando venta...');
    await axios.put(`${BASE_URL}/business/${BUSINESS_ID}/sale/${sale1Id}/close`, {
      userId: TEST_USER_ID,
      notes: 'Venta cerrada para probar propinas'
    });
    console.log('‚úÖ Venta cerrada');

    // Agregar propina en efectivo
    console.log('\nüí∏ Agregando propina en efectivo...');
    const tipResponse = await axios.post(`${BASE_URL}/cash-transaction/business/${BUSINESS_ID}/sales/${sale1Id}/tip`, {
      tipAmount: 20.00,
      tipPaymentMethod: 'cash',
      tipPercentage: 25, // 25% de propina
      tipReason: 'Excelente servicio',
      tipRecipient: expert1Id,
      notes: 'Propina voluntaria del cliente',
      userId: TEST_USER_ID
    });

    if (tipResponse.data.success) {
      console.log('‚úÖ Propina agregada exitosamente');
      console.log(`   ‚Ä¢ Monto: $${tipResponse.data.data.amount}`);
      console.log(`   ‚Ä¢ M√©todo: ${tipResponse.data.data.paymentMethod}`);
      console.log(`   ‚Ä¢ Balance anterior: $${tipResponse.data.data.previousBalance}`);
      console.log(`   ‚Ä¢ Nuevo balance: $${tipResponse.data.data.newBalance}`);
    }

    // ===== ESCENARIO 2: CLIENTE PAGA CON TRANSFERENCIA, DEVOLUCI√ìN EN EFECTIVO =====
    console.log('\nüè¶ ESCENARIO 2: Cliente paga con transferencia, devoluci√≥n en efectivo\n');

    // Crear otro cliente
    console.log('üë§ Creando cliente para escenario 2...');
    const client2Response = await axios.post(`${BASE_URL}/business/${BUSINESS_ID}/client`, {
      nameClient: 'Cliente Transferencia',
      email: 'transferencia@cliente.com',
      phone1: '555-8888'
    });

    if (!client2Response.data.success) {
      throw new Error('No se pudo crear el cliente 2');
    }

    const client2Id = client2Response.data.data._id;
    console.log(`‚úÖ Cliente creado: ${client2Id}`);

    // Crear una venta pagada con transferencia
    console.log('\nüõí Creando venta pagada con transferencia...');
    const sale2Response = await axios.post(`${BASE_URL}/business/${BUSINESS_ID}/sale`, {
      idClient: client2Id,
      nameClient: 'Cliente Transferencia',
      email: 'transferencia@cliente.com',
      date: new Date().toISOString(),
      services: [{
        serviceId: 2,
        expertId: expert1Id,
        input: [],
        amount: 120.00
      }],
      retail: [{
        productId: 1,
        clientPrice: 30.00,
        qty: 1,
        amount: 30.00,
        expertId: expert1Id
      }],
      total: 150.00,
      paymentMethod: [{
        payment: 'Transferencia',
        amount: 200.00 // Cliente pag√≥ de m√°s
      }],
      totalReceived: 200.00,
      totalChange: 50.00
    });

    if (!sale2Response.data.success) {
      throw new Error('No se pudo crear la venta 2');
    }

    const sale2Id = sale2Response.data.data._id;
    console.log(`‚úÖ Venta creada: ${sale2Id}`);
    console.log(`   ‚Ä¢ Servicio: $120.00`);
    console.log(`   ‚Ä¢ Retail: $30.00`);
    console.log(`   ‚Ä¢ Total: $150.00`);
    console.log(`   ‚Ä¢ Pagado: $200.00`);
    console.log(`   ‚Ä¢ Cambio a devolver: $50.00`);
    console.log(`   ‚Ä¢ M√©todo de pago: Transferencia`);

    // Cerrar la venta
    console.log('\nüìÑ Cerrando venta...');
    await axios.put(`${BASE_URL}/business/${BUSINESS_ID}/sale/${sale2Id}/close`, {
      userId: TEST_USER_ID,
      notes: 'Venta cerrada para probar devoluciones'
    });
    console.log('‚úÖ Venta cerrada');

    // Procesar devoluci√≥n en efectivo
    console.log('\nüíµ Procesando devoluci√≥n en efectivo...');
    const changeResponse = await axios.post(`${BASE_URL}/cash-transaction/business/${BUSINESS_ID}/sales/${sale2Id}/change`, {
      changeAmount: 50.00,
      changeReason: 'Cliente pag√≥ de m√°s con transferencia',
      changeNotes: 'Devoluci√≥n del excedente en efectivo',
      userId: TEST_USER_ID
    });

    if (changeResponse.data.success) {
      console.log('‚úÖ Devoluci√≥n procesada exitosamente');
      console.log(`   ‚Ä¢ Monto: $${changeResponse.data.data.amount}`);
      console.log(`   ‚Ä¢ Balance anterior: $${changeResponse.data.data.previousBalance}`);
      console.log(`   ‚Ä¢ Nuevo balance: $${changeResponse.data.data.newBalance}`);
    }

    // ===== ESCENARIO 3: REEMBOLSO COMPLETO =====
    console.log('\nüîÑ ESCENARIO 3: Reembolso completo\n');

    // Crear una venta para reembolso
    console.log('\nüõí Creando venta para reembolso...');
    const sale3Response = await axios.post(`${BASE_URL}/business/${BUSINESS_ID}/sale`, {
      idClient: client1Id,
      nameClient: 'Cliente Tarjeta',
      email: 'tarjeta@cliente.com',
      date: new Date().toISOString(),
      services: [{
        serviceId: 3,
        expertId: expert1Id,
        input: [],
        amount: 60.00
      }],
      retail: [],
      total: 60.00,
      paymentMethod: [{
        payment: 'Tarjeta',
        amount: 60.00
      }],
      totalReceived: 60.00,
      totalChange: 0
    });

    if (!sale3Response.data.success) {
      throw new Error('No se pudo crear la venta 3');
    }

    const sale3Id = sale3Response.data.data._id;
    console.log(`‚úÖ Venta creada: ${sale3Id}`);

    // Cerrar la venta
    console.log('\nüìÑ Cerrando venta...');
    await axios.put(`${BASE_URL}/business/${BUSINESS_ID}/sale/${sale3Id}/close`, {
      userId: TEST_USER_ID,
      notes: 'Venta cerrada para probar reembolso'
    });
    console.log('‚úÖ Venta cerrada');

    // Procesar reembolso
    console.log('\nüí∏ Procesando reembolso...');
    const refundResponse = await axios.post(`${BASE_URL}/cash-transaction/business/${BUSINESS_ID}/sales/${sale3Id}/refund`, {
      refundAmount: 60.00,
      refundMethod: 'cash',
      refundReason: 'Cliente no satisfecho con el servicio',
      refundNotes: 'Reembolso completo por insatisfacci√≥n',
      userId: TEST_USER_ID
    });

    if (refundResponse.data.success) {
      console.log('‚úÖ Reembolso procesado exitosamente');
      console.log(`   ‚Ä¢ Monto: $${refundResponse.data.data.amount}`);
      console.log(`   ‚Ä¢ M√©todo: ${refundResponse.data.data.paymentMethod}`);
      console.log(`   ‚Ä¢ Balance anterior: $${refundResponse.data.data.previousBalance}`);
      console.log(`   ‚Ä¢ Nuevo balance: $${refundResponse.data.data.newBalance}`);
    }

    // ===== ESCENARIO 4: AJUSTE DE CAJA =====
    console.log('\n‚öñÔ∏è ESCENARIO 4: Ajuste de caja\n');

    // Procesar ajuste de caja
    console.log('\nüí∞ Procesando ajuste de caja...');
    const adjustmentResponse = await axios.post(`${BASE_URL}/cash-transaction/business/${BUSINESS_ID}/cash-adjustment`, {
      adjustmentType: 'increase',
      adjustmentAmount: 25.00,
      adjustmentReason: 'Dep√≥sito de efectivo adicional',
      adjustmentNotes: 'Dep√≥sito realizado por el gerente',
      userId: TEST_USER_ID
    });

    if (adjustmentResponse.data.success) {
      console.log('‚úÖ Ajuste de caja procesado exitosamente');
      console.log(`   ‚Ä¢ Tipo: ${adjustmentResponse.data.data.adjustmentDetails.adjustmentType}`);
      console.log(`   ‚Ä¢ Monto: $${adjustmentResponse.data.data.adjustmentDetails.adjustmentAmount}`);
      console.log(`   ‚Ä¢ Raz√≥n: ${adjustmentResponse.data.data.adjustmentDetails.adjustmentReason}`);
      console.log(`   ‚Ä¢ Balance anterior: $${adjustmentResponse.data.data.previousBalance}`);
      console.log(`   ‚Ä¢ Nuevo balance: $${adjustmentResponse.data.data.newBalance}`);
    }

    // ===== VERIFICAR TRANSACCIONES =====
    console.log('\nüìã VERIFICANDO TRANSACCIONES DE CAJA\n');

    // Obtener todas las transacciones
    console.log('üìä Obteniendo todas las transacciones...');
    const transactionsResponse = await axios.get(`${BASE_URL}/cash-transaction/business/${BUSINESS_ID}/cash-transactions`);
    
    if (transactionsResponse.data.success) {
      const transactions = transactionsResponse.data.data;
      console.log(`‚úÖ Transacciones obtenidas: ${transactions.length}`);
      
      transactions.forEach((transaction, index) => {
        console.log(`   ${index + 1}. ${transaction.transactionType.toUpperCase()}: $${transaction.amount}`);
        console.log(`      ‚Ä¢ Estado: ${transaction.status}`);
        console.log(`      ‚Ä¢ M√©todo: ${transaction.paymentMethod}`);
        console.log(`      ‚Ä¢ Balance: $${transaction.previousBalance} ‚Üí $${transaction.newBalance}`);
      });
    }

    // Obtener reporte de transacciones
    console.log('\nüìà Obteniendo reporte de transacciones...');
    const reportResponse = await axios.get(`${BASE_URL}/cash-transaction/business/${BUSINESS_ID}/cash-transactions/report?groupBy=type`);
    
    if (reportResponse.data.success) {
      const report = reportResponse.data.data;
      console.log('‚úÖ Reporte obtenido:');
      console.log(`   ‚Ä¢ Total transacciones: ${report.totals.totalCount}`);
      console.log(`   ‚Ä¢ Monto total: $${report.totals.totalAmount}`);
      console.log(`   ‚Ä¢ Pendientes: $${report.totals.pendingAmount}`);
      console.log(`   ‚Ä¢ Completadas: $${report.totals.completedAmount}`);
      
      report.report.forEach((type, index) => {
        console.log(`   ‚Ä¢ ${type._id}: $${type.totalAmount} (${type.totalCount} transacciones)`);
      });
    }

    // ===== RESUMEN FINAL =====
    console.log('\nüéâ ¬°SISTEMA DE PROPINAS Y DEVOLUCIONES PROBADO EXITOSAMENTE!');
    console.log('\nüìã RESUMEN DE LA PRUEBA:');
    console.log(`   ‚Ä¢ Clientes creados: 2`);
    console.log(`   ‚Ä¢ Experto creado: 1`);
    console.log(`   ‚Ä¢ Ventas creadas: 3`);
    console.log(`   ‚Ä¢ Propina en efectivo: $20.00`);
    console.log(`   ‚Ä¢ Devoluci√≥n en efectivo: $50.00`);
    console.log(`   ‚Ä¢ Reembolso completo: $60.00`);
    console.log(`   ‚Ä¢ Ajuste de caja: +$25.00`);
    console.log(`   ‚Ä¢ Transacciones de caja: 4`);
    console.log(`   ‚Ä¢ Balance de caja actualizado autom√°ticamente`);
    console.log(`   ‚Ä¢ Auditor√≠a completa de transacciones`);

    console.log('\nüí° ESCENARIOS IMPLEMENTADOS:');
    console.log(`   ‚úÖ Cliente paga con tarjeta ‚Üí Propina en efectivo`);
    console.log(`   ‚úÖ Cliente paga con transferencia ‚Üí Devoluci√≥n en efectivo`);
    console.log(`   ‚úÖ Reembolso completo en efectivo`);
    console.log(`   ‚úÖ Ajustes de caja manuales`);
    console.log(`   ‚úÖ Tracking completo de balance`);
    console.log(`   ‚úÖ Validaciones de seguridad`);

    console.log('\nüöÄ EL SISTEMA EST√Å LISTO PARA PRODUCCI√ìN!');

  } catch (error) {
    console.error('‚ùå Error en la prueba:', error.message);
    if (error.response) {
      console.error('üìä Respuesta del servidor:', error.response.status, error.response.data);
    }
  }
}

// Ejecutar las pruebas
testTipsAndChangeSystem();
